<template>
    <div class="Walk">
        <div class="times">
          
          <svg viewBox="0 0 50 40" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <pattern id="Pattern_W" x="0" y="0" width="1" height="0.5">
                  <path transform="
                  rotate(180)
                  scale(0.2)
                  " class = "icon-path" fill = "white" d="m-73.75 -52.262c-0.51953-0.82812-1.1289-1.5312-1.8008-2.0898-1.1211-0.92969-2.4297-1.4688-3.8789-1.5781-2.5312-0.19922-4.8516 0.76172-6.7188 2.7812-3.0508 3.3008-4.6211 9.25-3.8086 14.449 0.32031 2.0508 0.69141 7.8008 0.070312 8.8789-1.1484 2.0312-1.1094 4.4883 0.12109 6.5781 3.7617 6.4297 12.891 2.8281 12.469-3.5195-0.019531-0.44922 0.23828-0.94922 0.87109-2.1289 0.75-1.4102 1.8906-3.5391 3.3594-7.3711 2.1016-5.4492 1.8281-12.02-0.67969-16zm-1.0586 15.32c-1.4219 3.7305-2.5312 5.7891-3.2617 7.1602-0.41016 0.76953-0.71094 1.3594-0.87891 1.9219l-8.9414-2.1719c0.55859-2.9492-0.19922-8.8906-0.21094-8.9492-0.71094-4.6094 0.69141-10.039 3.3398-12.898 1.3594-1.4609 2.9297-2.2109 4.6992-2.2109 0.17188 0 0.33984 0 0.5 0.019531 1.2305 0.10156 2.2891 0.60938 3.1914 1.4883 0.37109 0.37109 0.73047 0.80078 1.0391 1.3008 2.2109 3.5117 2.4219 9.4102 0.51953 14.328zm-30.301 19.961c-0.23828-0.42969-0.32812-1.5703-0.32812-2.9297 0-2.1016 0.19922-4.6992 0.39844-5.9414 0.80859-5.2188-0.75-11.16-3.8086-14.449-1.8594-2.0117-4.1992-2.9688-6.7188-2.7812-1.7383 0.14062-3.2812 0.87891-4.5312 2.1914-0.42188 0.42969-0.80078 0.92969-1.1484 1.4805-2.5 3.9805-2.7812 10.551-0.67969 16 1.4805 3.8281 2.6094 5.9609 3.3594 7.3711 0.62891 1.1797 0.87891 1.6914 0.87109 2.1211-0.16016 2.3789 1.1914 4.75 3.3789 6.0195 5.8086 3.3398 12.52-3.2695 9.2109-9.0586zm-11.809 0.050781c-0.73047-1.3711-1.8281-3.4414-3.2617-7.1602-1.9102-4.9414-1.6992-10.828 0.51172-14.34 0.26953-0.42969 0.57031-0.80859 0.87891-1.1406 0.94141-1 2.0703-1.5586 3.3594-1.6602 0.17188 0 0.33984-0.019531 0.5-0.019531 1.7695 0 3.3516 0.75 4.6992 2.2109 2.6484 2.8711 4.0586 8.2891 3.3398 12.91 0 0.070313-0.76953 6-0.21094 8.9414l-8.9297 2.1719c-0.19141-0.55078-0.48047-1.1484-0.89062-1.9102zm43.168-81.402c-0.51953-0.82812-1.1289-1.5312-1.8008-2.0898-1.1211-0.92187-2.4297-1.4609-3.8789-1.5781-2.5312-0.19141-4.8516 0.76953-6.7188 2.7812-3.0508 3.3008-4.6211 9.2383-3.8086 14.449 0.32031 2.0508 0.69141 7.8008 0.070312 8.8906-2.4805 4.3398 0.87109 9.9688 5.8906 9.9688h0.058594c1.8281-0.019531 3.6094-0.82031 4.9102-2.2188 1.2109-1.2891 1.8516-3.0117 1.7383-4.6797-0.019532-0.46094 0.23828-0.96094 0.87109-2.1406 0.75-1.4102 1.8906-3.5391 3.3594-7.3711 2.1016-5.4492 1.8281-12.02-0.67969-16zm-1.0586 15.32c-1.4219 3.7188-2.5312 5.7891-3.2617 7.1602-0.41016 0.76172-0.71094 1.3516-0.87891 1.9102l-8.9414-2.1719c0.55859-2.9414-0.19922-8.8789-0.21094-8.9492-0.71094-4.6094 0.69141-10.039 3.3398-12.898 1.3594-1.4609 2.9297-2.2109 4.6992-2.2109 0.17188 0 0.33984 0 0.5 0.019532 1.2305 0.10156 2.2891 0.60938 3.1914 1.4883 0.37109 0.37109 0.73047 0.80078 1.0391 1.3008 2.2109 3.5117 2.4219 9.4102 0.51953 14.328zm-30.301 19.961c-0.60938-1.0781-0.23828-6.8398 0.070313-8.8789 0.80859-5.2188-0.75-11.16-3.8086-14.449-1.8594-2.0117-4.1992-2.9688-6.7188-2.7812-1.7383 0.12891-3.2812 0.87891-4.5312 2.1797-0.42188 0.44141-0.80078 0.92969-1.1484 1.4805-2.5 3.9805-2.7812 10.559-0.67969 16 2.6484 6.8906 4.2695 8.4297 4.2305 9.4883-0.10938 1.6797 0.51953 3.3984 1.7383 4.7109 5.5117 5.9297 14.621-1.1406 10.852-7.7617zm-10.922 1.9688c-0.57031-1.7383-1.8203-3-4.1484-9.0781-0.87109-2.25-1.3008-4.6992-1.3008-7.0312 0-2.7812 0.60938-5.3984 1.8203-7.3086 0.26953-0.42969 0.57031-0.80859 0.87891-1.1406 0.94141-1 2.0703-1.5508 3.3594-1.6484 0.17188-0.019531 0.33984-0.019531 0.5-0.019531 1.7695 0 3.3516 0.73828 4.6992 2.2109 2.6484 2.8594 4.0586 8.2812 3.3398 12.898 0 0.070312-0.76953 6-0.21094 8.9414l-8.9297 2.1797z"/>
                </pattern>
              </defs>
            <rect fill="url(#Pattern_W)" x = "0" width="100%" height="40" />
          </svg>
        </div>
        <div class="detail">
            <h3>徒歩</h3>
        </div>
    </div>
</template>

<script setup lang="ts">
import { onMounted,watch,defineEmits } from 'vue';
import { type Trip,type changes } from  './types'
import axios from 'axios'

const props = defineProps<{
  trip: Trip
}>();

const emit = defineEmits<{
  (e:'changed',value?:changes):void,
}>()

watch(() => props.trip, async (newTrip) => {
  if (newTrip.start.longitude !== undefined && newTrip.start.latitude !== undefined){
    console.log(props.trip.start.latitude, props.trip.start.longitude)
  }
  console.log(props.trip.end.latitude, props.trip.end.longitude);
  if (newTrip.end.longitude !== undefined && newTrip.end.latitude !== undefined) {

    if (newTrip.geometry !== undefined) {
      return;
    }

    console.log(String(newTrip.start.latitude) + ',' + String(newTrip.start.longitude))
    console.log(String(newTrip.end.latitude) + ',' + String(newTrip.end.longitude))
    const response =await axios.get("https://navitime-route-walk.p.rapidapi.com/shape_walk",
          {
            headers: {
              'X-RapidAPI-Key': import.meta.env.VITE_ROUTE_MANAGER_API_KEY,
              'X-RapidAPI-Host': 'navitime-route-walk.p.rapidapi.com'
            },
            params: {
              start: String(newTrip.start.latitude) + ',' + String(newTrip.start.longitude),
              goal: String(newTrip.end.latitude) + ',' + String(newTrip.end.longitude),
              coord_unit: 'degree',
              format: 'geojson',
              datum: 'wgs84',
              speed: 5
            }
          }
        )

    console.log(response.data)
    var geometry: {type:string,coordinates:Number[][]} = {
      type:response.data.features[0].geometry.type,
      coordinates: []
    }

    for(var feature of response.data.features ){
      console.log(feature.coordinates)
      geometry.coordinates = [...geometry.coordinates,...feature.geometry.coordinates?.map((coordinate:[number,number])=>[coordinate[1],coordinate[0]]) ?? []]

    }
    

    const changes: changes = {
      id: props.trip.id,
      start: props.trip.start,
      
      end: props.trip.end,
      name: props.trip.name,
      kind: props.trip.kind,
      geometry: geometry
    };

    emit('changed', changes);
  }
}, { immediate: true,deep: true });

</script>

<style scoped>
.Walk {
  display: flex;
  align-items: top;
}
.times {
  width: 220px;
  height: 68px;
  justify-content: center;
}
.time {
    margin: 0;
    color: #9c9c9c;
    margin-right: 50px;
}

</style>
<style>
.section:has(.Walk) {
  margin-bottom: 00px;
}
.section:has(+ .section:has(.Walk)){
  margin-bottom: 00px;
}
</style>